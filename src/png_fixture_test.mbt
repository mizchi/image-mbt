///|
// PNG fixture tests: decode PNGs generated by Pillow (PIL) / manual libpng-compatible construction.
// All fixtures are license-free, generated programmatically.

/// Helper: assert RGBA pixel at (x, y) in decoded image
fn assert_pixel(
  img : ImageData,
  x : Int,
  y : Int,
  r : Int,
  g : Int,
  b : Int,
  a : Int,
) -> Unit raise {
  let idx = (y * img.width + x) * 4
  assert_eq(img.data[idx].to_int(), r)
  assert_eq(img.data[idx + 1].to_int(), g)
  assert_eq(img.data[idx + 2].to_int(), b)
  assert_eq(img.data[idx + 3].to_int(), a)
}

///|
// Pillow-generated RGBA 2x2: red, green, blue, white
test "fixture: decode RGBA 2x2 (Pillow)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x02\x00\x00\x00\x02\x08\x06\x00\x00\x00\x72\xB6\x0D\x24\x00\x00\x00\x14\x49\x44\x41\x54\x78\x9C\x63\xF8\xCF\xC0\xF0\x1F\x04\x59\x18\xC1\x34\x03\x03\x00\x3E\xFF\x06\x00\xFA\x5C\x13\xB0\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 2)
  assert_eq(img.height, 2)
  assert_pixel(img, 0, 0, 255, 0, 0, 255) // red
  assert_pixel(img, 1, 0, 0, 255, 0, 255) // green
  assert_pixel(img, 0, 1, 0, 0, 255, 255) // blue
  assert_pixel(img, 1, 1, 255, 255, 255, 255) // white
}

///|
// Pillow-generated RGB 2x2: red, green, blue, white
test "fixture: decode RGB 2x2 (Pillow)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x02\x00\x00\x00\x02\x08\x02\x00\x00\x00\xFD\xD4\x9A\x73\x00\x00\x00\x16\x49\x44\x41\x54\x78\x9C\x63\xF8\xCF\xC0\xC0\xF0\x9F\x81\x91\x81\xE1\xFF\xFF\xFF\x0C\x00\x1E\xF6\x04\xFD\x09\xED\x34\x3E\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 2)
  assert_eq(img.height, 2)
  assert_pixel(img, 0, 0, 255, 0, 0, 255)
  assert_pixel(img, 1, 0, 0, 255, 0, 255)
  assert_pixel(img, 0, 1, 0, 0, 255, 255)
  assert_pixel(img, 1, 1, 255, 255, 255, 255)
}

///|
// Pillow-generated Grayscale 2x2: 0, 85, 170, 255
test "fixture: decode Grayscale 2x2 (Pillow)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x02\x00\x00\x00\x02\x08\x00\x00\x00\x00\x57\xDD\x52\xF8\x00\x00\x00\x0E\x49\x44\x41\x54\x78\x9C\x63\x60\x08\x65\x58\xF5\x1F\x00\x03\xAD\x01\xFF\x67\xFB\xCA\x09\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 2)
  assert_eq(img.height, 2)
  assert_pixel(img, 0, 0, 0, 0, 0, 255)
  assert_pixel(img, 1, 0, 85, 85, 85, 255)
  assert_pixel(img, 0, 1, 170, 170, 170, 255)
  assert_pixel(img, 1, 1, 255, 255, 255, 255)
}

///|
// Pillow-generated GrayscaleAlpha 2x2: (0,255), (128,200), (255,100), (64,50)
test "fixture: decode GrayscaleAlpha 2x2 (Pillow)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x02\x00\x00\x00\x02\x08\x04\x00\x00\x00\xD8\xBF\xC5\xAF\x00\x00\x00\x12\x49\x44\x41\x54\x78\x9C\x63\x64\xF8\xDF\x70\x92\xE1\x7F\x8A\x83\x11\x00\x16\x1C\x04\x1F\x4F\xE5\xC5\x45\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 2)
  assert_eq(img.height, 2)
  assert_pixel(img, 0, 0, 0, 0, 0, 255)
  assert_pixel(img, 1, 0, 128, 128, 128, 200)
  assert_pixel(img, 0, 1, 255, 255, 255, 100)
  assert_pixel(img, 1, 1, 64, 64, 64, 50)
}

///|
// Manually constructed Indexed 2x2: palette [red, green, blue, yellow]
test "fixture: decode Indexed 2x2 (manual)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x02\x00\x00\x00\x02\x08\x03\x00\x00\x00\x45\x68\xFD\x16\x00\x00\x00\x0C\x50\x4C\x54\x45\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF\xFF\xFF\x00\xD6\x02\x8F\x7B\x00\x00\x00\x0E\x49\x44\x41\x54\x78\x9C\x63\x60\x60\x64\x60\x62\x06\x00\x00\x11\x00\x07\x9E\xA2\x2A\x12\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 2)
  assert_eq(img.height, 2)
  assert_pixel(img, 0, 0, 255, 0, 0, 255) // red
  assert_pixel(img, 1, 0, 0, 255, 0, 255) // green
  assert_pixel(img, 0, 1, 0, 0, 255, 255) // blue
  assert_pixel(img, 1, 1, 255, 255, 0, 255) // yellow
}

///|
// Pillow-generated RGBA 4x4 gradient (exercises PNG filters)
test "fixture: decode RGBA 4x4 gradient (Pillow)" {
  let png = b"\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x04\x00\x00\x00\x04\x08\x06\x00\x00\x00\xA9\xF1\x9E\x7E\x00\x00\x00\x1D\x49\x44\x41\x54\x78\x9C\x63\x64\x60\x60\xF8\x1F\xCA\xA0\xC5\x00\xC3\x2C\x0C\xA1\x5A\x0C\x0C\x0C\x08\x4C\x58\x00\x00\xE9\xCB\x05\x81\x67\xE0\xB8\xB9\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82"
  let img = decode_png(png)
  assert_eq(img.width, 4)
  assert_eq(img.height, 4)
  // Verify corners: pixel(x,y) = (x*85, y*85, (x+y)*42, 255)
  assert_pixel(img, 0, 0, 0, 0, 0, 255)
  assert_pixel(img, 3, 0, 255, 0, 126, 255)
  assert_pixel(img, 0, 3, 0, 255, 126, 255)
  assert_pixel(img, 3, 3, 255, 255, 252, 255)
  // Verify middle pixel
  assert_pixel(img, 1, 1, 85, 85, 84, 255)
}
